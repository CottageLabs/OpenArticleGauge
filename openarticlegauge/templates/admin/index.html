{% extends "base.html" %}
{% block title %}Admin Area{% endblock %}
{% block head %}
  {{ super() }}
{% endblock %}
{% block content %}

<script type="text/javascript">
jQuery(document).ready(function($) {

    var record_url = '/query/?';
    var record_datatype = 'JSONP';
    
    var record_resdisplay = [
        [
            {
                "pre": '<strong>Identifier(s)</strong>: <span class="identifier">',
                "field": "identifier.id",
                "post": "</span>"
            }
        ],
        [
            {
                "pre": "<strong>licenses</strong>: ",
                "field": "license.title"
            },
            {
                "pre": " (",
                "field": "license.type",
                "post": ")"
            }
        ],
        [
            {
                "pre": "<strong>Open Access?</strong>: ",
                "field": "license.open_access"
            }
        ],
        [
            {
                "pre": "<strong>BY?</strong>: ",
                "field": "license.BY"
            },
            {
                "pre": " <strong>NC</strong>: ",
                "field": "license.NC"
            },
            {
                "pre": " <strong>SA</strong>: ",
                "field": "license.SA"
            },
            {
                "pre": " <strong>ND</strong>: ",
                "field": "license.ND"
            }
        ],
        [
            {
                "pre": "<strong>OKD compliant?</strong> ",
                "field": "license.is_okd_compliant"
            },
            {
                "pre": " <strong>OSI compliant?</strong> ",
                "field": "license.is_osi_compliant"
            }
        ],
        [
            {
                "pre": "Learn more about this license at ",
                "field": "license.url"
            }
        ],
        [
            {
                "pre": "<strong>We retrieved this information from</strong> ",
                "field": "license.provenance.source",
                "post": ". "
            }
        ],
        [
            {
                "pre": "<strong>Last checked on</strong> ",
                "field":"license.provenance.date",
                "post":"."
            }
        ],
        [
            {
                "pre" : "<strong>Handler</strong>: ",
                "field" : "license.provenance.handler",
            },
            {
                "pre" : " (",
                "field" : "license.provenance.handler_version",
                "post" : ")"
            }
        ]
    ];

    var record_facets = [
        {'field': 'license.type.exact', 'display': 'License type'},
        {'field': 'license.provenance.handler.exact', 'display': 'Handler'},
        {'field': 'license.provenance.handler_version.exact', 'display': 'Handler Version'}
    ];

    function postSearch() {
        var type_filter = undefined
        var handler_filter = undefined
        var version_filter = undefined
        
        $(".facetview_filterselected").each(function() {
            if ($(this).attr("rel") === "license.type.exact") {
                type_filter = $(this).attr("href")
            }
            if ($(this).attr("rel") === "license.provenance.handler.exact") {
                handler_filter = $(this).attr("href")
            }
            if ($(this).attr("rel") === "license.provenance.handler_version.exact") {
                version_filter = $(this).attr("href")
            }
        })
        
        $("#invalidate_licenses").unbind("click")
        
        if (type_filter || handler_filter) {
            // enable the submission
            $("#invalidate_licenses").removeAttr("disabled")
            $("#invalidate_confirm").removeAttr("disabled")
            
            // bind the functionality to the button
            $("#invalidate_licenses").click(function(event) {
                event.preventDefault()
                var qy = $("#facetview").facetview.options.querystring
                var usersays = $("#invalidate_confirm").is(":checked")
                if (usersays){
                    $.ajax({
                        type: "get",
                        url: "{{url_for('admin.invalidate')}}",
                        data: {source: qy },
                        dataType: "jsonp",
                        success: function(data) {
                            alert(JSON.stringify(data))
                        }
                    })
                }
            })
            
        } else {
            // uncheck the confirm box and disable everything
            $("#invalidate_licenses").attr("disabled", "disabled")
            $("#invalidate_confirm").attr("disabled", "disabled")
            $("#invalidate_confirm").attr("checked", false)
        }
        
        // update the UI
        if (type_filter) {
            $("#license_type").html(type_filter)
        } else {
            $("#license_type").html("any")
        }
        if (handler_filter) {
            $("#handler").html(handler_filter)
        } else {
            $("#handler").html("any")
        }
        if (version_filter) {
            $("#handler_version").html(version_filter)
        } else {
            $("#handler_version").html("any")
        }
    }
    
    var opts = {
        search_url: record_url,
        datatype: record_datatype,
        facets: record_facets,
        searchbox_shade: "#fff",
        result_display: record_resdisplay,
        sharesave_link: false,
        paging: {
            size: 25
        },
        display_images: false,
        pager_on_top: true,
        post_search_callback: postSearch
    };

    $('#facetview').facetview(opts);

    

});

</script>


<div class="row-fluid oag-unit">
    <div class="hero-unit clearfix">
        <h1>OAG Administration Area</h1>
        <p>Search/Browse the records that are currently in the database, and perform administrative actions on them</p>
    </div>
</div>

<div class="row-fluid">
    <div class="span9"><div id="facetview"></div></div>
    <div class="span3">
        <div class="row-fluid">
            <div class="span12">
                <div class="well">
                    <form action="POST">
                        <h3>Invalidate Licences</h3>
                        <strong>License Type</strong>: <span id="license_type">any</span><br>
                        <strong>Handler</strong>: <span id="handler">any</span><br>
                        <strong>Handler Version</strong>: <span id="handler_version">any</span><br><br>
                        <button id="invalidate_licenses" class="btn btn-danger" disabled="disabled">Invalidate Selected Licenses</button><br>
                        <input id="invalidate_confirm" type="checkbox" name="confirm" value="confirm" disabled="disabled">&nbsp;Yes, I'm sure!
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}
